From 8f44ba778ed305c1d615fbae6039ad1ac367c947 Mon Sep 17 00:00:00 2001
From: Tamas K Lengyel <lengyelt@ainfosec.com>
Date: Wed, 25 Oct 2017 11:12:04 -0600
Subject: [PATCH] XSM: add config option to override bootloader provided policy

---
 xen/common/Kconfig | 14 ++++++++++++++
 xen/xsm/xsm_core.c |  2 ++
 2 files changed, 16 insertions(+)

diff --git a/xen/common/Kconfig b/xen/common/Kconfig
index 103ef44cb5..5ad0d03f37 100644
--- a/xen/common/Kconfig
+++ b/xen/common/Kconfig
@@ -140,6 +140,20 @@ config XSM_POLICY
 
 	  If unsure, say Y.
 
+config XSM_POLICY_OVERRIDE
+	bool "Built-in security policy overrides bootloader provided policy"
+	default n
+	depends on XSM && XSM_POLICY
+	---help---
+	  Set this option to 'Y' to have the hypervisor ignore the security
+	  policy provided by the bootloader, and use ONLY the built-in
+	  security policy.
+
+	  This can be used to ensure only verified security policies are
+	  loaded during boot time.
+
+	  If unsure, say N.
+
 config LATE_HWDOM
 	bool "Dedicated hardware domain"
 	default n
diff --git a/xen/xsm/xsm_core.c b/xen/xsm/xsm_core.c
index 08994ee7a1..2d5c1d3fec 100644
--- a/xen/xsm/xsm_core.c
+++ b/xen/xsm/xsm_core.c
@@ -39,7 +39,9 @@ static inline int verify(struct xsm_operations *ops)
 static int __init xsm_core_init(const void *policy_buffer, size_t policy_size)
 {
 #ifdef CONFIG_XSM_POLICY
+#ifndef CONFIG_XSM_POLICY_OVERRIDE
     if ( policy_size == 0 )
+#endif
     {
         policy_buffer = xsm_init_policy;
         policy_size = xsm_init_policy_size;
-- 
2.11.0

